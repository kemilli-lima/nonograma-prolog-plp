% M√≥dulo ui_core.pl - Sistema de Interface do Usu√°rio
%
% Respons√°vel por:
% - Renderiza√ß√£o gr√°fica do jogo
% - Exibi√ß√£o de menus e telas
% - Formata√ß√£o de elementos visuais
% - Gerenciamento de cores e estilos

:- module(ui_core, [
    init_ui/0,              % Inicializa sistema de UI
    clear_screen/0,         % Limpa a tela do terminal
    draw_title/0,           % Exibe t√≠tulo art√≠stico do jogo
    draw_ui/1,             % Renderiza interface completa do jogo
    show_victory/1,        % Mostra tela de vit√≥ria
    show_game_over/1,      % Mostra tela de game over
    cleanup_systems/0,     % Finaliza sistemas de UI
    block_cell_row/2       % Auxiliar para renderiza√ß√£o de linhas
]).

:- use_module(library(lists)).      % Para opera√ß√µes com listas
:- use_module('../constants').      % Para constantes de cores
:- use_module('../core/game_state'). % Para manipula√ß√£o do estado do jogo
:- use_module(library(clpfd)).      % Para restri√ß√µes l√≥gicas
:- use_module('../utils').          % Para utilit√°rios


% =============================================
% INICIALIZA√á√ÉO E FINALIZA√á√ÉO
% =============================================

%% init_ui
% Inicializa o sistema de interface do usu√°rio
init_ui.

% =============================================
% CONTROLE DE TELA
% =============================================

%% clear_screen
% Limpa o terminal usando sequ√™ncias de escape ANSI
clear_screen :-
    write('\33[2J\33[H').

%% draw_title
% Exibe o t√≠tulo art√≠stico do jogo em ASCII com cores
draw_title :-
    constants:title_color(Title),
    constants:reset_color(Reset),
    format("~s", [Title]),
    format("‚ñà‚ñà  ‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà  ‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà ‚ñà   ‚ñà ‚ñà‚ñà‚ñà‚ñà  ~n"),
    format("‚ñà ‚ñà ‚ñà ‚ñà   ‚ñà ‚ñà ‚ñà ‚ñà ‚ñà   ‚ñà ‚ñà      ‚ñà  ‚ñà ‚ñà  ‚ñà ‚ñà‚ñà ‚ñà‚ñà ‚ñà  ‚ñà~n"),
    format("‚ñà  ‚ñà‚ñà ‚ñà   ‚ñà ‚ñà  ‚ñà‚ñà ‚ñà   ‚ñà ‚ñà ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà ‚ñà ‚ñà ‚ñà ‚ñà‚ñà‚ñà‚ñà ~n"),
    format("‚ñà   ‚ñà  ‚ñà‚ñà‚ñà  ‚ñà   ‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà  ‚ñà ‚ñà  ‚ñà ‚ñà   ‚ñà ‚ñà  ‚ñà ~n~n"),
    format("~s", [Reset]).

% =============================================
% RENDERIZA√á√ÉO PRINCIPAL
% =============================================

%% draw_ui(+GameState)
% Renderiza a interface completa do jogo incluindo:
% - Tabuleiro com estado atual
% - Dicas de linhas/colunas
% - Cursor de sele√ß√£o
% - Contador de vidas
% - Menu de controles
draw_ui(GameState) :-
    clear_screen,
    draw_title,
    GameState = game_state(Board, Lives, Game, _Solved, (SelRow, SelCol)),
    Game = game(_, RowHints, ColHints, _),
    
    print_lives(Lives), nl,
    build_ui_blocks(Board, RowHints, ColHints, SelRow, SelCol, Lines),
    maplist(writeln, Lines), nl,
    print_game_menu, 
    flush_output(user_output).

%% print_lives(+Lives)
% Exibe contador de vidas com √≠cones de cora√ß√£o
print_lives(Lives) :-
    constants:error_color(ErrorColor), 
    constants:reset_color(ResetColor),
    format('~sVidas restantes: ', [ErrorColor]),
    print_hearts(Lives),
    format('~s', [ResetColor]).

%% print_hearts(+Lives)
% Auxiliar para exibir √≠cones de cora√ß√£o conforme vidas restantes
print_hearts(Lives) :-
    Lives > 0,
    forall(between(1, Lives, _), write('‚ù§Ô∏è ')).
print_hearts(_) :- write('').

% =============================================
% CONSTRU√á√ÉO DE BLOCOS VISUAIS
% =============================================

%% build_ui_blocks(+Board, +RowHints, +ColHints, +SelRow, +SelCol, -Lines)
% Constr√≥i a representa√ß√£o visual completa do tabuleiro:
% - Dicas de coluna no topo
% - Dicas de linha √† esquerda
% - C√©lulas do tabuleiro
% - Destaque para c√©lula selecionada
build_ui_blocks(Board, RowHints, ColHints, SelRow, SelCol, Lines) :-
    maplist(clean_hint_list, RowHints, CleanedHints),
    maplist(length, CleanedHints, RowHintLengths),
    max_list(RowHintLengths, MaxHintLen),
    block_row_hints(CleanedHints, MaxHintLen, RowHintBlocks),
    
    length(Board, NumRows),
    NumRowsMinus1 is NumRows - 1,
    findall(I, between(0, NumRowsMinus1, I), RowIndices),
    maplist(build_board_row(SelRow, SelCol), RowIndices, Board, BoardBlocks),
    maplist(block_cell_row, BoardBlocks, CellBlocks),
    
    merge_row_blocks(RowHintBlocks, CellBlocks, BodyLines),
    get_row_hint_width(RowHintBlocks, Pad),
    Pad2 is Pad + 1,
    block_col_hints(ColHints, Pad2, ColHintLines),
    append(ColHintLines, BodyLines, Lines).

%% clean_hint_list(+Hints, -Cleaned)
% Normaliza dicas removendo zeros desnecess√°rios
clean_hint_list([0], ["0"]) :- !.
clean_hint_list(Hints, Cleaned) :-
    exclude(==(0), Hints, NoZeros),
    maplist(number_string, NoZeros, Strs),
    ( Strs = [] -> Cleaned = [""] ; Cleaned = Strs ).


% =============================================
% RENDERIZA√á√ÉO DE DICAS
% =============================================

%% block_row_hints(+HintsList, +MaxHints, -HintBlocks)
% Formata dicas de linha com alinhamento consistente
block_row_hints([], _, []).
block_row_hints([Hints|Rest], MaxHints, [LineBlock|RestLines]) :-
    length(Hints, Len),
    Pad is MaxHints - Len,
    length(Prefix, Pad),
    maplist(=(""), Prefix),
    append(Prefix, Hints, FullHints),
    maplist(format_hint, FullHints, HintStrs),
    atomic_list_concat(HintStrs, '', HStr),
    format(string(Line), '~w ', [HStr]),
    LineBlock = [Line],
    block_row_hints(Rest, MaxHints, RestLines).

%% format_hint(+Hint, -Formatted)
% Formata dicas individuais com padding consistente
format_hint("", "    ").
format_hint(H, Fmt) :- 
    ( H = "0" -> Fmt = "    "
    ; format(string(Fmt), "~|~t~w~4+", [H])
    ).

% =============================================
% RENDERIZA√á√ÉO DO TABULEIRO
% =============================================

%% build_board_row(+SelRow, +SelCol, +RowIdx, +Row, -BlockRow)
% Constr√≥i representa√ß√£o visual de uma linha do tabuleiro
build_board_row(SelRow, SelCol, RowIdx, Row, BlockRow) :-
    length(Row, NumCols),
    NumColsMinus1 is NumCols - 1,
    findall(I, between(0, NumColsMinus1, I), ColIndices),
    maplist(build_cell(RowIdx, SelRow, SelCol), ColIndices, Row, BlockRow).

%% build_cell(+RIdx, +SRow, +SCol, +CIdx, +Cell, -Block)
% Constr√≥i representa√ß√£o visual de uma c√©lula individual
build_cell(RIdx, SRow, SCol, CIdx, Cell, Block) :-
    (RIdx =:= SRow, CIdx =:= SCol -> Selected = true ; Selected = false),
    block_cell(Cell, Selected, Block).

%% block_cell(+CellState, +Selected, -Block)
% Mapeia estados de c√©lula para representa√ß√£o visual
block_cell(filled, false, [" üüß "]).  % C√©lula preenchida
block_cell(marked, false, [" ‚ùå "]).  % C√©lula marcada como vazia
block_cell(empty, false,  [" ¬∑  "]).  % C√©lula vazia
block_cell(filled, true,  ["[üüß]"]). % C√©lula selecionada
block_cell(marked, true,  ["[‚ùå]"]). % C√©lula selecionada
block_cell(empty, true,   ["[¬∑ ]"]). % C√©lula selecionada

% =============================================
% MANIPULA√á√ÉO DE LINHAS E COLUNAS DO TABULEIRO
% =============================================

%% block_cell_row(+Cells, -BlockRow)
% Converte uma linha de c√©lulas em sua representa√ß√£o textual
% 
% Par√¢metros:
%   Cells    - Lista de blocos de c√©lulas (cada c√©lula √© uma lista com um elemento)
%   BlockRow - Lista de strings prontas para exibi√ß√£o
%
% Funcionamento:
%   Extrai o primeiro elemento de cada bloco de c√©lula usando nth0/3
block_cell_row(Cells, BlockRow) :-
    maplist(nth0(0), Cells, BlockRow).

%% merge_row_blocks(+RowHints, +CellBlocks, -MergedLines)
% Combina blocos de dicas de linha com blocos de c√©lulas em linhas completas
%
% Par√¢metros:
%   RowHints   - Lista de dicas de linha formatadas
%   CellBlocks - Lista de blocos de c√©lulas formatadas
%   MergedLines- Linhas completas prontas para exibi√ß√£o
%
% Funcionamento:
%   Concatena as dicas de linha com as c√©lulas correspondentes
%   e junta os elementos em uma √∫nica string por linha
merge_row_blocks([], [], []).
merge_row_blocks([H1|T1], [H2|T2], [Line|Rest]) :-
    append(H1, H2, Row),                        % Combina dicas e c√©lulas
    atomic_list_concat(Row, '', Line),          % Junta elementos em string
    merge_row_blocks(T1, T2, Rest).             % Processa recursivamente

%% block_col_hints(+Hints, +RowHintWidth, -Lines)
% Formata as dicas de coluna para exibi√ß√£o acima do tabuleiro
%
% Par√¢metros:
%   Hints        - Lista de dicas de coluna originais
%   RowHintWidth - Largura necess√°ria para alinhamento com as dicas de linha
%   Lines        - Linhas formatadas das dicas de coluna
%
% Fluxo:
% 1. Limpa e converte dicas para strings
% 2. Calcula altura m√°xima das colunas
% 3. Adiciona padding para uniformizar altura
% 4. Transp√µe matriz para exibi√ß√£o horizontal
% 5. Formata cada linha com padding de alinhamento
block_col_hints(Hints, RowHintWidth, Lines) :-
    maplist(clean_hint_list_col, Hints, HintsStr),  % Limpa dicas
    max_column_height(HintsStr, MaxHeight),         % Calcula altura m√°xima
    pad_column_hints(HintsStr, MaxHeight, Padded),  % Adiciona padding
    transpose(Padded, Rows),                        % Transp√µe matriz
    maplist(format_col_hint_line, Rows, RawLines),  % Formata linhas
    format_padding(RowHintWidth, Padding),          % Cria padding para alinhamento
    % Aplica padding a cada linha usando lambda
    maplist({Padding}/[L,Out]>>string_concat(Padding,L,Out), RawLines, Lines).

%% format_padding(+Width, -Padding)
% Cria uma string de espa√ßos para alinhamento
%
% Par√¢metros:
%   Width   - N√∫mero de espa√ßos a serem criados
%   Padding - String resultante com espa√ßos
format_padding(Width, Padding) :-
    length(SpaceList, Width),                   % Cria lista de espa√ßos
    maplist(=(' '), SpaceList),                 % Garante que s√£o espa√ßos
    atomic_list_concat(SpaceList, '', Padding). % Converte para string

%% clean_hint_list_col(+Hints, -Cleaned)
% Filtra e converte dicas de coluna num√©ricas para strings
%
% Par√¢metros:
%   Hints   - Lista de n√∫meros representando dicas
%   Cleaned - Lista de strings limpas (sem zeros)
clean_hint_list_col(Hints, Cleaned) :-
    exclude(==(0), Hints, NoZeros),             % Remove zeros
    maplist(number_string, NoZeros, Cleaned).   % Converte para strings

%% format_col_hint_line(+Hints, -Line)
% Formata uma linha de dicas de coluna com padding consistente
%
% Par√¢metros:
%   Hints - Lista de strings de dicas
%   Line  - String formatada com padding uniforme
format_col_hint_line(Hints, Line) :-
    maplist(pad_hint, Hints, Final),        % Aplica padding a cada dica
    atomic_list_concat(Final, '', Line).    % Junta em uma string

%% pad_hint(+Hint, -Out)
% Formata uma dica individual com padding fixo de 4 caracteres
%
% Par√¢metros:
%   Hint - String com a dica original
%   Out  - String formatada com padding
pad_hint(Hint, Out) :-
    format(string(Out), "~|~w~t~4+", [Hint]).   % Formata com 4 caracteres de largura

%% pad_column_hints(+Hints, +Max, -Padded)
% Adiciona padding vertical √†s colunas de dicas para uniformizar altura
%
% Par√¢metros:
%   Hints  - Lista de listas de dicas por coluna
%   Max    - Altura m√°xima desejada
%   Padded - Lista com colunas preenchidas com strings vazias
pad_column_hints([], _, []).
pad_column_hints([H|T], Max, [Padded|Rest]) :-
    length(H, Len),
    Pad is Max - Len,                       % Calcula padding necess√°rio
    length(Suffix, Pad),                    % Cria lista de padding
    maplist(=(""), Suffix),                 % Preenche com strings vazias
    append(Suffix, H, Padded),              % Adiciona padding no in√≠cio
    pad_column_hints(T, Max, Rest).         % Processa recursivamente

%% max_column_height(+Hints, -Max)
% Calcula a altura m√°xima entre todas as colunas de dicas
%
% Par√¢metros:
%   Hints - Lista de listas de dicas por coluna
%   Max   - Maior comprimento encontrado
max_column_height(Hints, Max) :-
    maplist(length, Hints, Lengths),    % Obt√©m comprimento de cada coluna
    max_list(Lengths, Max).             % Encontra o valor m√°ximo

%% get_row_hint_width(+HintBlocks, -MaxWidth)
% Calcula a largura m√°xima das dicas de linha para alinhamento
%
% Par√¢metros:
%   HintBlocks - Lista de blocos de dicas de linha
%   MaxWidth   - Maior largura encontrada
get_row_hint_width([], 0).
get_row_hint_width([[Str]|T], MaxWidth) :-
    string_length(Str, Len),                % Obt√©mcomprimento da string
    get_row_hint_width(T, Rest),            % Calcula recursivamente
    max_list([Len, Rest], MaxWidth).        % Determina o m√°ximo

% =============================================
% MENU DO JOGO
% =============================================

%% print_game_menu
% Exibe o menu de controles do jogo com formata√ß√£o colorida
print_game_menu :-
    constants:title_color(TitleColor),
    constants:blue_color(BlueColor),
    constants:warning_color(WarningColor),
    constants:magenta_color(MagentaColor),
    constants:success_color(SuccessColor),
    constants:reset_color(Reset),
    constants:error_color(RedColor),
    

    format("~s‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó~n", [TitleColor]),
    format("~s‚ïë              ‚óÜ ESCOLHA UMA OP√á√ÉO ‚óÜ                 ‚ïë~n", [TitleColor]),
    format("~s‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£~n", [TitleColor]),

    format("~s‚ïë ‚û§  Mover c√©lula  ‚Üí  teclas w / a / s / d           ‚ïë~n", [BlueColor]),
    format("~s", [Reset]),

    format("~s‚ïë ‚û§  Preencher c√©lula  ‚Üí  tecla f                    ‚ïë~n", [WarningColor]),
    format("~s", [Reset]),

    format("~s‚ïë ‚û§  Marcar c√©lula  ‚Üí  tecla m                       ‚ïë~n", [MagentaColor]),
    format("~s", [Reset]),

    format("~s‚ïë ‚û§  Pedir dica  ‚Üí  tecla h                          ‚ïë~n", [RedColor]),
    format("~s", [Reset]),

    format("~s‚ïë ‚û§  Sair  ‚Üí  tecla q                                ‚ïë~n", [Reset]),
    format("~s", [Reset]),

    format("~s‚ïë ‚û§  Salvar jogo (Use a tecla v)                     ‚ïë~n", [SuccessColor]),
    format("~s", [Reset]),

    format("~s‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù~n~n", [TitleColor]),
    format("~s", [Reset]).

% =============================================
% TELAS DE FIM DE JOGO
% =============================================

%% show_victory(+GameState)
% Exibe tela de vit√≥ria mantendo o estado final do tabuleiro
show_victory(GameState) :-
    draw_ui(GameState),
    write('\nüéâ Voc√™ venceu! Parab√©ns! üéâ\n').

%% show_game_over(+GameState)
% Exibe tela de game over mantendo o estado final do tabuleiro
show_game_over(GameState) :-
    draw_ui(GameState),
    write('\n‚ò†Ô∏è  Game Over! Tente novamente.\n').

% =============================================
% FINALIZA√á√ÉO
% =============================================

%% cleanup_systems
% Realiza limpeza final dos sistemas de UI
cleanup_systems :-
    format("~sSistema encerrado com seguran√ßa.~n", [constants:title_color]),
    constants:reset_color, nl.